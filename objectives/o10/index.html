<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Thomas Bouve">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Recover Cleartext Document - </title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/gruvbox-light.min.css">
        <link href="../../css/extra.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/css.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/powershell.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../.."></a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Welcome</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Objectives <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../o1/">Talk to Santa & Find the Turtle Doves</a>
</li>
                                    
<li >
    <a href="../o2/">Unredact Threatening Document</a>
</li>
                                    
<li >
    <a href="../o3/">Evaluate Attack Outcome</a>
</li>
                                    
<li >
    <a href="../o4/">Determine Attacker Technique</a>
</li>
                                    
<li >
    <a href="../o5/">Determine Compromised System</a>
</li>
                                    
<li >
    <a href="../o6/">Splunk</a>
</li>
                                    
<li >
    <a href="../o7/">Get Access to the Steam Tunnels</a>
</li>
                                    
<li >
    <a href="../o8/">Bypassing the Frido Sleigh CAPTEHA</a>
</li>
                                    
<li >
    <a href="../o9/">Retrieve Scraps of Paper from Server</a>
</li>
                                    
<li class="active">
    <a href="./">Recover Cleartext Document</a>
</li>
                                    
<li >
    <a href="../o11/">Open the Sleigh Shop Door</a>
</li>
                                    
<li >
    <a href="../o12/">Filter Out Poisoned Data Sources</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Terminal Hints <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../hints/h3/">Bushy Evergreen - Escape Ed</a>
</li>
                                    
<li >
    <a href="../../hints/h4/">SugarPlum Mary - Linux Path</a>
</li>
                                    
<li >
    <a href="../../hints/h5/">Sparkle Redberry - Xmas Cheer Laser</a>
</li>
                                    
<li >
    <a href="../../hints/h6/">Tangle Coalbox - Frosty Keypad</a>
</li>
                                    
<li >
    <a href="../../hints/h7/">Minty Candycane - Holiday Hack Trail</a>
</li>
                                    
<li >
    <a href="../../hints/h8/">Alabaster Snowball - Nyanshell</a>
</li>
                                    
<li >
    <a href="../../hints/h9/">Pepper Minstix - Graylog</a>
</li>
                                    
<li >
    <a href="../../hints/h10/">Holly Evergreen - Mongo Pilfer</a>
</li>
                                    
<li >
    <a href="../../hints/h11/">Kent Tinseltooth - Smart Braces</a>
</li>
                                    
<li >
    <a href="../../hints/h12/">Wunorse Openslae - Zeek JSON Analysis</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Miscellaneous <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../misc/interesting_ui/">Interesting UI Elements</a>
</li>
                                    
<li >
    <a href="../../misc/progress_tokens/">Progress Tokens</a>
</li>
                                    
<li >
    <a href="../../misc/user_accounts/">User Accounts</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../../scripts/">Scripts</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../o9/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../o11/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#recover-cleartext-document">Recover Cleartext Document</a></li>
            <li><a href="#request">Request</a></li>
            <li><a href="#video">Video</a></li>
            <li><a href="#resources">Resources</a></li>
            <li><a href="#solution">Solution</a></li>
            <li><a href="#answer">Answer</a></li>
            <li><a href="#response">Response</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="recover-cleartext-document">Recover Cleartext Document<a class="headerlink" href="#recover-cleartext-document" title="Permanent link">#</a></h1>
<p><strong>Terminal Hint</strong>: <a href="../../hints/h10/">Holly Evergreen - Mongo Pilfer</a></p>
<h2 id="request">Request<a class="headerlink" href="#request" title="Permanent link">#</a></h2>
<blockquote>
<p>The <a href="https://downloads.elfu.org/elfscrow.exe">Elfscrow Crypto</a> tool is a vital asset used at Elf University for encrypting SUPER SECRET documents.<br />
We can't send you the source, but we do have <a href="https://downloads.elfu.org/elfscrow.pdb">debug symbols</a> that you can use.<br />
Recover the plaintext content for this <a href="https://downloads.elfu.org/ElfUResearchLabsSuperSledOMaticQuickStartGuideV1.2.pdf.enc">encrypted document</a>.<br />
We know that it was encrypted on December 6, 2019, between 7pm and 9pm UTC.<br />
What is the middle line on the cover page? (Hint: it's five words)</p>
</blockquote>
<h2 id="video">Video<a class="headerlink" href="#video" title="Permanent link">#</a></h2>
<p><div class="video-wrapper">
<iframe width="560" height="315" src="https://www.youtube.com/embed/PPbELj4PeKk?start=123" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div></p>
<h2 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">#</a></h2>
<ul>
<li><a href="https://downloads.elfu.org/elfscrow.exe">Elfscrow Crypto Binary</a></li>
<li><a href="https://downloads.elfu.org/elfscrow.pdb">Elfscrow Debug Symbols</a></li>
<li><a href="https://downloads.elfu.org/ElfUResearchLabsSuperSledOMaticQuickStartGuideV1.2.pdf.enc">Encrypted PDF Document</a></li>
<li><a href="https://youtu.be/obJdpKDpFBA">Ron Bowes, Reversing Crypto the Easy Way</a></li>
<li><a href="https://tinyurl.com/kringlecon-crypto">Reversing Crypto Demo Code &amp; Slides</a></li>
<li><a href="https://www.hex-rays.com/products/ida/support/download_freeware.shtml">IDA</a></li>
<li><a href="https://www.nsa.gov/resources/everyone/ghidra/">Ghidra</a> </li>
</ul>
<h2 id="solution">Solution<a class="headerlink" href="#solution" title="Permanent link">#</a></h2>
<p>The most helpful resource for this objective is defnitely Ron Bowes' <a href="https://youtu.be/obJdpKDpFBA">Reversing Crypto the Easy Way</a> presentation. It goes over a lot of information and is well worth the time. If you're new to crypto then you'll definitely learn more than a few things (like I did). Start by encrypting a plain text document with the <a href="https://downloads.elfu.org/elfscrow.exe"><code>elfscrow.exe</code></a> crypto tool and looking at the program output.</p>
<pre><code class="shell">elfscrow.exe --encrypt test.txt test.txt.enc
</code></pre>

<p><img alt="Elfscrow.exe" src="../../img/objectives/o10/o10_1.png" /></p>
<p>The <code>elfscrow.exe</code> application prints the seed, generates and prints the encryption key, encrypts the file, sends the key to the <a href="https://elfscrow.elfu.org/api/store">elfscrow server</a> for storage, and finally prints a secret ID which can be used to retrieve the key from the server and decrypt the file again. The output provides two additional pieces of information. First, the seed value looks like the current date and time represented in <a href="https://www.epochconverter.com">epoch format</a>. Secondly, the key length is 8 bytes which could indicate DES. </p>
<p>Open up the <code>elfscrow.exe</code> binary and <a href="https://downloads.elfu.org/elfscrow.pdb"><code>elfscrow.pdb</code></a> debug symbols in IDA to better understand how exactly the tool uses the seed to generate the 8-byte encryption key and what algorithm is being used. Start by looking at the <code>generate_key</code> function.</p>
<p><img alt="generate_key" src="../../img/objectives/o10/o10_2_dontbelieveyou.png" /></p>
<p>This function first calls <code>time</code>, then <code>super_secure_srand</code> to initialize the seed, and finally loops 8 times over the <code>super_secure_random</code> pseudo-random number generator (PRNG) function to create the 8-byte encryption key. The <code>super_secure_srand</code> function doesn't to do much more than print and then store the seed in <code>state</code>.</p>
<p><img alt="super_secure_srand" src="../../img/objectives/o10/o10_3.png" /></p>
<p>The <code>super_secure_random</code> function then takes the seed value stored in <code>state</code>, multiplies it by 343FDh (i.e. 214013 in decimal), adds 269EC3h (i.e. 2531011 in decimal), and saves this value in <code>state</code> as the new seed value. It continues with bit-shifting the current value, bitwise AND-ing with 7FFFh (i.e. 32767 in decimal), and returning this value as the next key byte. </p>
<p><img alt="super_secure_random" src="../../img/objectives/o10/o10_4.png" /></p>
<p>Translating <code>super_secure_random</code> into Python gives us the below function.</p>
<pre><code class="python">def rand():
    &quot;&quot;&quot;Generate random value.&quot;&quot;&quot;
    # 1. get seed value
    # 2. multiply seed by 214013
    # 3. add 2531011 (this is our new seed value)
    # 4. right shift seed by 16
    # 5. bitwise AND with 32767
    global seed
    seed = (214013 * seed + 2531011)
    val = seed &gt;&gt; 16
    return (val &amp; 32767)
</code></pre>

<p>Doing the same for the <code>generate_key</code> function results in the following function.</p>
<pre><code class="python">def generate_key(val):
    &quot;&quot;&quot;Generate encryption key.&quot;&quot;&quot;
    global seed
    seed = val
    encrypted = []
    for _x in range(8):
        tmp = hex(rand())
        if len(str(tmp)) == 6:
            encrypted.append(str(tmp)[4:])
        elif len(str(tmp)) == 5:
            encrypted.append(str(tmp)[3:])
        elif len(str(tmp)) == 4:
            encrypted.append(str(tmp)[2:])
        elif len(str(tmp)) == 3:
            encrypted.append(f&quot;0{str(tmp)[-1]}&quot;)
    return ''.join(encrypted)
</code></pre>

<p>Now that we've determined the initial seed value (i.e. epoch time) and replicated the algorithm to generate the 8-byte key, we need to determine what encryption algorithm is used by <code>elfscrow.exe</code>. The <code>do_encrypt</code> function provides some useful hints.</p>
<p><img alt="super_secure_srand" src="../../img/objectives/o10/o10_5.png" /></p>
<p>First there's the obvious "CryptImportKey failed for DES-CBC key" comment. While a comment can contain incorrect information it's confirmed by the <a href="https://docs.microsoft.com/en-us/windows/win32/seccrypto/alg-id"><code>6601h</code></a> algorithm ID value (i.e. CALG_DES) which is used as input for the <a href="https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptimportkey"><code>CryptImportKey</code></a> function. Our initial suspicion that DES is being used based on the 8-byte key length appears to be correct.</p>
<p>The final piece of the puzzle is the hint that the file was encrypted on December 6, 2019, between 7pm and 9pm UTC. This gives us a 7200-second window or 7200 possible seed values starting from 1575658800 (i.e. epoch time for December 6, 2019, 7pm). We can now complete the <a href="../../scripts/#decrypt_pdfpy"><code>decrypt_pdf.py</code></a> Python script by adding the following code.</p>
<pre><code class="python">def main():
    &quot;&quot;&quot;Execute.&quot;&quot;&quot;
    # File names
    encinfile = 'ElfUResearchLabsSuperSledOMaticQuickStartGuideV1.2.pdf.enc'
    pdfoutfile = 'ElfUResearchLabsSuperSledOMaticQuickStartGuideV1.2.pdf'

    # Friday, December 6, 2019 7:00:00 PM
    start = 1575658800

    # Loop over 2 hours and generate the key for each
    for x in range(7200):
        keyseed = start + x
        key = generate_key(keyseed)
        bytekey = bytearray.fromhex(key)

        # Prep for decrypting DES-CBC
        cipher = DES.new(
            bytekey,
            DES.MODE_CBC,
            iv=bytearray.fromhex('0000000000000000')
        )

        # Read encrypted file
        f = open(encinfile, 'rb')
        encrypted = f.read()

        # Decrypt using the current key
        msg = (cipher.iv + cipher.decrypt(encrypted))

        # Check if decryption was successful
        if msg[9:12] == b'PDF':
            # Yes, we got a PDF!
            print(f'Pass {x}: {key} decrypts to a PDF!')
            f = open(pdfoutfile, 'wb')
            f.write(msg)
            break
        else:
            # Womp womp! On to the next.
            print(f'Pass {x}: {key} is no bueno!')
</code></pre>

<p>All 7200 possible seeds are used to generate the associated keys. Each key is then used to decrypt the file and if the decrypted file header indicates it's a PDF file we know the decryption was successful, in which case we break out of the loop.</p>
<p><img alt="File Decrypted" src="../../img/objectives/o10/o10_6.png" /></p>
<p>The correct key is found on attempt 4850 which tells us the file was encrypted on Friday, December 6, 2019 8:20:50 PM.</p>
<p><img alt="PDF Cover" src="../../img/objectives/o10/o10_7.png" /></p>
<p>Sweet! <a href="../../files/ElfUResearchLabsSuperSledOMaticQuickStartGuideV1.2.pdf">Super Sled-O-Matic quick-start guide v1.2</a> successfully decrypted! Someone needs to have a serious talk with Santa and explain to him that ElfScrow version 1.01 is in urgent need of an update though. Way too much DES and PRNG shenanigans and I'd have some serious reservations slapping my name on the whole 'the only encryption trusted by Santa!' tagline if I were him.</p>
<h2 id="answer">Answer<a class="headerlink" href="#answer" title="Permanent link">#</a></h2>
<p>Middle line on the cover page: <code>Machine Learning Sleigh Route Finder</code></p>
<h2 id="response">Response<a class="headerlink" href="#response" title="Permanent link">#</a></h2>
<p>None</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Thomas Bouve - <a href="https://twitter.com/crahan">@CraHan</a></p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
