# Pepper Minstix - "Graylog"
![Pepper Minstix](../img/hints/h9/pepper_minstix.png){: .elf_avatar}

Provides a hint for [Retrieve the Scraps of Paper from Server](../../challenges/c9/).

## Request
> It's me - Pepper Minstix.  
> Normally I'm jollier, but this Graylog has me a bit mystified.  
> Have you used Graylog before? It is a log management system based on Elasticsearch, MongoDB, and Scala. Some Elf U computers were hacked, and I've been tasked with performing incident response.  
> Can you help me fill out the incident response report using our instance of Graylog?  
> It's probably helpful if you know a few things about Graylog.  
> Event IDs and Sysmon are important too. Have you spent time with those?  
> Don't worry - I'm sure you can figure this all out for me!  
> Click on the All messages Link to access the Graylog search interface!  
> Make sure you are searching in all messages!  
> The [Elf U Graylog server](https://graylog.elfu.org) has an integrated incident response reporting system.  
> Just mouse-over the box in the lower-right corner.  
> Login with the username elfustudent and password elfustudent.

## Resources
- [Graylog Docs](http://docs.graylog.org/en/3.1/pages/queries.html)

## Solution
### Question 1
Minty CandyCane reported some weird activity on his computer after he clicked on a link in Firefox for a cookie recipe and downloaded a file. What is the full-path + filename of the first malicious file downloaded by Minty?  
Explanation: search for sysmon file creation events (ID 2) made by Firefox (with some filtering).

```text
EventID:2 AND ProcessImage:C\:\\*firefox.exe AND NOT TargetFilename:C\:\\*.temp
```

**Answer**: C:\Users\minty\Downloads\cookie_recipe.exe

### Question 2
The malicious file downloaded and executed by Minty gave the attacker remote access to his machine. What was the ip:port the malicious file connected to first?  
Explanation: search for network events (ID 3) made by the cookie_recipe.exe binary.

```text
EventID:3 AND ProcessImage:C\:\\Users\\minty\\Downloads\\cookie_recipe.exe
```

**Answer**: 192.168.247.175:4444

### Question 3
What was the first command executed by the attacker? (answer is a single word)  
Explanation: search for all processes with a cookie_recipe.exe parent (and sort by timestamp to find the earliest activity).

```text
EventID:1 AND source:elfu-res-wks1 AND ParentProcessImage:C\:\\Users\\minty\\Downloads\\cookie_recipe.exe
```

**Answer**: whoami

### Question 4
What is the one-word service name the attacker used to escalate privileges?  
Explanation: using the same query we also find service related commands further down the list.

```text
EventID:1 AND source:elfu-res-wks1 AND ParentProcessImage:C\:\\Users\\minty\\Downloads\\cookie_recipe.exe
```

**Answer**: webexservice

### Question 5
What is the file-path + filename of the binary ran by the attacker to dump credentials?  
Explanation: the attacker pivots to using cookie_recipe2.exe so we search for that binary as a parent.

```text
EventID:1 AND source:elfu-res-wks1 AND ParentProcessImage:C\:\\Users\\minty\\Downloads\\cookie_recipe2.exe
```

**Answer**: C:\cookie.exe

### Question 6
The attacker pivoted to another workstation using credentials gained from Minty's computer. Which account name was used to pivot to another machine?  
Explanation: we look for event ID 4624 with source IP 192.168.247.175.

```text
EventID:4624 AND NOT AccountName:SYSTEM AND SourceNetworkAddress:192.168.247.175
```

**Answer**: alabaster (on elfu-res-wks2)

### Question 7
What is the time (HH:MM:SS) the attacker makes a Remote Desktop connection to another machine?  
Explanation: search for EventID 4624 and LogonType 10 (RemoteInteractive)

```text
(EventID:4624 AND LogonType:10) OR DestinationPort:3389
```

**Answer**: 06:04:28

### Question 8
The attacker navigates the file system of a third host using their Remote Desktop Connection to the second host. What is the SourceHostName,DestinationHostname,LogonType of this connection? (submit in that order as csv)  
Explanation: search for Logon events on elfu-res-wks3 after the initial activity (source is in log data)

```text
DestinationHostname:elfu-res-wks3 AND timestamp:["2019-11-19 06:04:28.000" TO *] AND EventID:4624
```

**Answer**: ELFU-RES-WKS2,elfu-res-wks3,3

### Question 9
What is the full-path + filename of the secret research document after being transferred from the third host to the second host?  
Explanation: search for explorer.exe processes changing a file creation time, after the RDP login, and on host elfu-res-wks2

```text
EventID:2 AND source:elfu-res-wks2 AND timestamp:["2019-11-19 06:04:28.000" TO *] AND ProcessImage:C\:\\*xplorer.*
```

**Answer**: C:\Users\alabaster\Desktop\super_secret_elfu_research.pdf

### Question 10
What is the IPv4 address (as found in logs) the secret research document was exfiltrated to?  
Explanation: we know it's pastebin from the final PowerShell command that exfils the data.

```text
DestinationHostname:pastebin.com AND EventID:3 AND SourceHostname:elfu-res-wks2*
```

**Answer**: 104.22.3.84

## Answer
1. `C:\Users\minty\Downloads\cookie_recipe.exe`
2. `192.168.247.175:4444`
3. `whoami`
4. `webexservice`
5. `C:\cookie.exe`
6. `alabaster`
7. `06:04:28`
8. `ELFU-RES-WKS2,elfu-res-wks3,3`
9. `C:\Users\alabaster\Desktop\super_secret_elfu_research.pdf`
10. `104.22.3.84`

## Hint
> That's it - hooray!  
> Have you had any luck retrieving scraps of paper from the Elf U server?  
> You might want to look into [SQL injection](https://www.owasp.org/index.php/SQL_Injection) techniques.  
> OWASP is always a good resource for web attacks.  
> For blind SQLi, I've heard Sqlmap is a great tool.  
> In certain circumstances though, you need custom [tamper scripts](https://pen-testing.sans.org/blog/2017/10/13/sqlmap-tamper-scripts-for-the-win) to get things going!
