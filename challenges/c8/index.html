<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Thomas Bouve">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Bypassing the Frido Sleigh CAPTEHA - CraHan's KringleCon 2 Write-Up</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/gruvbox-light.min.css">
        <link href="../../css/extra.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/css.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/powershell.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">CraHan's KringleCon 2 Write-Up</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Challenges <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../c1/">Talk to Santa & Find the Turtle Doves</a>
</li>
                                    
<li >
    <a href="../c2/">Unredact Threatening Document</a>
</li>
                                    
<li >
    <a href="../c3/">Evaluate Attack Outcome</a>
</li>
                                    
<li >
    <a href="../c4/">Determine Attacker Technique</a>
</li>
                                    
<li >
    <a href="../c5/">Determine Compromised System</a>
</li>
                                    
<li >
    <a href="../c6/">Splunk</a>
</li>
                                    
<li >
    <a href="../c7/">Get Access to the Steam Tunnels</a>
</li>
                                    
<li class="active">
    <a href="./">Bypassing the Frido Sleigh CAPTEHA</a>
</li>
                                    
<li >
    <a href="../c9/">Retrieve the Scraps of Paper from Server</a>
</li>
                                    
<li >
    <a href="../c10/">Recover Cleartext Document</a>
</li>
                                    
<li >
    <a href="../c11/">Open the Sleigh Shop Door</a>
</li>
                                    
<li >
    <a href="../c12/">Filter Out Poisoned Data Sources</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Hints <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../hints/h3/">Bushy Evergreen - Escape Ed</a>
</li>
                                    
<li >
    <a href="../../hints/h4/">SugarPlum Mary - Linux Path</a>
</li>
                                    
<li >
    <a href="../../hints/h5/">Sparkle Redberry - Xmas Cheer Laser</a>
</li>
                                    
<li >
    <a href="../../hints/h6/">Tangle Coalbox - Frosty Keypad</a>
</li>
                                    
<li >
    <a href="../../hints/h7/">Minty Candycane - Holiday Hack Trail</a>
</li>
                                    
<li >
    <a href="../../hints/h8/">Alabaster Snowball - Nyanshell</a>
</li>
                                    
<li >
    <a href="../../hints/h9/">Pepper Minstix - Graylog</a>
</li>
                                    
<li >
    <a href="../../hints/h10/">Holly Evergreen - Mongo Pilfer</a>
</li>
                                    
<li >
    <a href="../../hints/h11/">Kent Tinseltooth - Smart Braces</a>
</li>
                                    
<li >
    <a href="../../hints/h12/">Wunorse Openslae - Zeek JSON Analysis</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Scripts <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../scripts/find_code.py/">find_code.py</a>
</li>
                                    
<li >
    <a href="../../scripts/capteha_api.py/">capteha_api.py</a>
</li>
                                    
<li >
    <a href="../../scripts/token_proxy.py/">token_proxy.py</a>
</li>
                                    
<li >
    <a href="../../scripts/decrypt_pdf.py/">decrypt_pdf.py</a>
</li>
                                    
<li >
    <a href="../../scripts/match_user_agents.py/">match_user_agents.py</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Misc <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../misc/interesting_ui/">Interesting UI Elements</a>
</li>
                                    
<li >
    <a href="../../misc/progress_tokens/">Progress Tokens</a>
</li>
                                    
<li >
    <a href="../../misc/user_accounts/">User Accounts</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../c7/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../c9/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#bypassing-the-frido-sleigh-capteha">Bypassing the Frido Sleigh CAPTEHA</a></li>
            <li><a href="#request">Request</a></li>
            <li><a href="#video">Video</a></li>
            <li><a href="#resources">Resources</a></li>
            <li><a href="#solution">Solution</a></li>
            <li><a href="#answer">Answer</a></li>
            <li><a href="#hint">Hint</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="bypassing-the-frido-sleigh-capteha">Bypassing the Frido Sleigh CAPTEHA<a class="headerlink" href="#bypassing-the-frido-sleigh-capteha" title="Permanent link">#</a></h1>
<p><strong>Hint</strong>: <a href="../../hints/h8/">Alabaster Snowball - Nyanshell</a></p>
<h2 id="request">Request<a class="headerlink" href="#request" title="Permanent link">#</a></h2>
<blockquote>
<p>Help Krampus beat the <a href="https://fridosleigh.com/">Frido Sleigh contest</a>.<br />
For hints on achieving this objective, please talk &gt; with Alabaster Snowball in the Speaker Unpreparedness Room.  </p>
<p>Krampus: <br />
The contest is here on my screen and at <a href="https://fridosleigh.com/">fridosleigh.com</a>.<br />
No purchase necessary, enter as often as you want, so I am!<br />
They set up the rules, and lately, I have come to realize that I have certain materialistic, cookie needs.<br />
Unfortunately, it's restricted to elves only, and I can't bypass the CAPTEHA.<br />
(That's Completely Automated Public Turing test to tell Elves and Humans Apart.)<br />
I've already cataloged <a href="https://downloads.elfu.org/capteha_images.tar.gz">12,000 images</a> and decoded the <a href="https://downloads.elfu.org/capteha_api.py">API interface</a>.<br />
Can you help me bypass the CAPTEHA and submit lots of entries?</p>
</blockquote>
<h2 id="video">Video<a class="headerlink" href="#video" title="Permanent link">#</a></h2>
<p><div class="video-wrapper">
<iframe width="560" height="315" src="https://www.youtube.com/embed/zYifAGvMEw4?start=182" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div></p>
<h2 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">#</a></h2>
<ul>
<li><a href="https://fridosleigh.com/">fridosleigh.com</a></li>
<li><a href="https://downloads.elfu.org/capteha_images.tar.gz">Image Training Data</a></li>
<li><a href="https://downloads.elfu.org/capteha_api.py">CAPTEHA API interface</a></li>
<li><a href="https://github.com/chrisjd20/img_rec_tf_ml_demo">TensorFlow Machine Learning Demo Code</a></li>
<li><a href="https://youtu.be/jmVPLwjm_zs">Chris Davis, Machine Learning Use Cases for Cybersecurity</a></li>
</ul>
<h2 id="solution">Solution<a class="headerlink" href="#solution" title="Permanent link">#</a></h2>
<p>Buckle up as we just reached the difficulty 4 and 5 challenges. Free Frido Sleigh cookies for life sounds like a pretty sweet deal, except for one minor issue. The form contains one of those super annoying <a href="https://fridosleigh.com/about_CAPTEHA.html">CAPTEHA</a> tests.</p>
<p><em>"A “CAPTEHA” is a Turing test to tell elves and humans apart. It is easy for an elf to solve because elves are magical creatures that work on holiday related objects year-round and can spot and click hundreds of holiday items per second. However, non-elves (like humans) will find it nearly impossible to visualize, correctly identify and click holiday items fast enough before the time runs out."</em></p>
<p><img alt="CAPTEHA Fail" src="../../img/challenges/c8/c8_1_faster.png" /></p>
<p>In order to get around this we need a script that grabs the CAPTEHA data from <a href="https://fridosleigh.com/">fridosleigh.com</a>, loops over all 100 images, selects the correct types, submits the final selection, and finally spams the hell out of the Frido Sleigh contest form. Luckily, all of the steps required, except for the image prediction portion, are already handled by the <a href="https://downloads.elfu.org/capteha_api.py"><code>capteha_api.py</code></a> script we receive from Krampus.</p>
<p>For the image processing and prediction step, download and unpack the <a href="https://downloads.elfu.org/capteha_images.tar.gz">12,000 images</a> and clone or download the <a href="https://github.com/chrisjd20/img_rec_tf_ml_demo">TensorFlow Machine Learning Demo</a> Github repository. Follow the demo instructions to install the required Python packages.</p>
<pre><code class="shell">git clone https://github.com/chrisjd20/img_rec_tf_ml_demo.git
cd img_rec_tf_ml_demo
sudo apt install python3 python3-pip -y
sudo python3 -m pip install --upgrade pip
sudo python3 -m pip install --upgrade setuptools
sudo python3 -m pip install --upgrade tensorflow==1.15
sudo python3 -m pip install tensorflow_hub
</code></pre>

<p>Next, train the TensorFlow Machine Learning model by running the <a href="https://github.com/chrisjd20/img_rec_tf_ml_demo/blob/master/retrain.py"><code>retrain.py</code></a> script and providing the image folder as input. Depending on the hardware resources available this could create problems later on. On some hardware and with the default model it can take longer than 10 seconds to check each of the 100 images and fail the test as a result. The documentation at the top of the <code>retrain.py</code> script provides a possible solution though.</p>
<p><em>"By default this script will use the highly accurate, but comparatively large and slow Inception V3 model architecture. It's recommended that you start with this to validate that you have gathered good training data, but if you want to deploy on resource-limited platforms, you can try the <code>--tfhub_module</code> flag with a Mobilenet model."</em></p>
<p>The default 299 x 299 image resolution used in <code>retrain.py</code> far exceeds what we need for the smaller CAPTEHA image data. A <a href="https://research.googleblog.com/2017/06/mobilenets-open-source-models-for.html">Mobilenet model</a> with a smaller image size (i.e. 128 x 128) is more than enough and will, as the <code>retrain.py</code> documentation describes, give us faster speeds. Train the TensorFlow Machine Learning model using the sample images provided by Krampus and the proper Mobilenet model (i.e. 100 neurons and 128 input image size) as input.</p>
<pre><code class="shell"> python retrain.py --image_dir ./training_images --tfhub_module \
 https://tfhub.dev/google/imagenet/mobilenet_v1_100_128/quantops/feature_vector/3
</code></pre>

<p>Once training is complete grab all the functions and remaining code from the <a href="https://github.com/chrisjd20/img_rec_tf_ml_demo/blob/master/predict_images_using_trained_model.py"><code>predict_images_using_trained_model.py</code></a> demo script and add them to <code>capteha_api.py</code>. Be sure to update both the <code>input_height</code> and <code>input_width</code> parameters in the <code>read_tensor_from_image_bytes</code> function to match the value defined by the selected Mobilenet model as well. The <a href="../../scripts/capteha_api.py/">final script</a> can be found in the 'Scripts' section, but a few code snippets from the <code>main</code> function are highlighted below. </p>
<p>Request a CAPTEHA, store the image data, and parse out the image types we need to select.</p>
<pre><code class="python">url = &quot;https://fridosleigh.com/&quot;

# Create session
s = requests.Session()

# Get CAPTEHA images and types
r = s.post(f'{url}api/capteha/request')
if (r.json()['request']):
    images = r.json()['images']
    types = [x.strip() for x in r.json()['select_type'].split(',')]
    types[-1] = types[-1].replace('and ', '')
</code></pre>

<p>Next, iterate over the images and for each image extract the UUID, convert the BASE64 image data to binary, and use both as input to process and predict the image. Wait for all processing to finish (i.e. the queue size matches the number of images) and create a list containing the final prediction results.</p>
<pre><code class="python"># Can use queues and threading to spead up the processing
q = queue.Queue()

# Going to interate over each of our images.
for image in images:
    img_uuid = image['uuid']
    img_base64 = image['base64']
    print('Processing Image {}'.format(img_uuid))

    # We don't want to process too many images at once. 10 threads max
    while len(threading.enumerate()) &gt; 10:
        time.sleep(0.0001)

    # Predict_image function is expecting png image bytes so we read
    # image as 'rb' to get a bytes object
    image_bytes = base64.b64decode(img_base64)
    threading.Thread(
        target=predict_image,
        args=(
            q,
            sess,
            graph,
            image_bytes,
            img_uuid,
            labels,
            input_operation,
            output_operation
        )
    ).start()

print('Waiting For Threads to Finish...')
while q.qsize() &lt; len(images):
    time.sleep(0.001)

# Getting a list of all threads returned results
prediction_results = [q.get() for x in range(q.qsize())]
</code></pre>

<p>Loop over the prediction results and, if an image matches a requested type, add its UUID to the <code>answers</code> list.</p>
<pre><code class="python">answers = []

# What are we looking for?
print(f'Looking for {types}')

# Get the matching images
for prediction in prediction_results:
    if prediction['prediction'] in types:
        print(f&quot;{prediction['img_uuid']} is a {prediction['prediction']}.&quot;)
        answers.append(prediction['img_uuid'])

final_answer = ','.join(answers)
</code></pre>

<p>The remainder of Krampus' <code>capteha_api.py</code> script submits the list of UUIDs and, if successful, sends the Frido Sleigh form over and over again until a response is returned informing us we won. Be sure to replace <code>yourREALemailAddress</code> with a working email address though as the system needs to be able to send out a confirmation email. </p>
<p><img alt="CAPTEHA Bypassed" src="../../img/challenges/c8/c8_2.png" />
<img alt="Server Response" src="../../img/challenges/c8/c8_3.png" />
<img alt="Email" src="../../img/challenges/c8/c8_4.png" /></p>
<h2 id="answer">Answer<a class="headerlink" href="#answer" title="Permanent link">#</a></h2>
<p>Email code: <code>8Ia8LiZEwvyZr2WO</code></p>
<h2 id="hint">Hint<a class="headerlink" href="#hint" title="Permanent link">#</a></h2>
<blockquote>
<p>You did it! Thank you so much. I can trust you!<br />
To help you, I have flashed the firmware in your badge to unlock a useful new feature:<br />
magical teleportation through the steam tunnels.<br />
As for those scraps of paper, I scanned those and put the images on my server.<br />
I then threw the paper away.<br />
Unfortunately, I managed to lock out my account on the server.<br />
Hey! You’ve got some great skills. Would you please hack into my system and retrieve the scans?<br />
I give you permission to hack into it, solving Objective 9 in your badge.<br />
And, as long as you're traveling around, be sure to solve any other challenges you happen across.</p>
</blockquote></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Thomas Bouve - <a href="https://twitter.com/crahan">@CraHan</a></p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
